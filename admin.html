<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo • LUARY SHOP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root { --navy: #1a2a3a; --gold: #c5a059; }
        body { background:#fdfdfd; color:var(--navy); font-family:Inter,Arial; margin:0; }
        nav button.active { border-bottom:2px solid var(--gold); color:var(--gold); }
        section { display:none; min-height:300px; }
        section.active { display:block; }
        .card { background:#fff; border:1px solid #eee; border-radius:16px; padding:14px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .btn { background:#f4f4f4; border:1px solid #ddd; padding:8px 12px; border-radius:8px; font-size:11px; cursor:pointer; transition: 0.3s; color: var(--navy); }
        .btn:hover { background:#eee; }
        .btn-gold { background:var(--navy); color:#fff; font-weight:700; padding:10px; border-radius:8px; cursor:pointer; }
        .btn-gold:hover { background:var(--gold); }
        input, select { background:#fff; border:1px solid #ddd; padding:8px; border-radius:8px; width:100%; margin-bottom:8px; color:var(--navy); outline:none; font-size: 13px; }
        .promo-row { display: grid; grid-template-columns: 1fr 80px 120px 80px; gap: 8px; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
    </style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-[#1a2a3a] border-b border-[#c5a059] text-[#c5a059] tracking-widest uppercase">
    LUARY SHOP • Gestão Administrativa
</header>

<nav class="flex gap-2 p-2 bg-white border-b sticky top-0 z-50 overflow-x-auto justify-center">
    <button type="button" class="btn active" onclick="showTab('empresa', this)">Loja</button>
    <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
    <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
    <button type="button" class="btn" onclick="showTab('promocoes', this)">Promoções</button>
    <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
    
    <section id="empresa" class="active">
        <div class="card space-y-3">
            <h2 class="text-[#c5a059] font-bold uppercase text-sm">Configuração da Luary</h2>
            <input id="empNome" placeholder="Nome da Loja">
            <input id="empSub" placeholder="Slogan">
            <input id="empWhats" placeholder="WhatsApp (Ex: 5511999999999)">
            
            <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                <div>
                    <label class="text-[10px] font-bold uppercase text-gray-400">Desconto Pix (%)</label>
                    <input id="empDescPix" type="number" placeholder="Ex: 5">
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase text-gray-400">Parcelas s/ Juros</label>
                    <input id="empParcelas" type="number" placeholder="Ex: 3">
                </div>
            </div>
            
            <button class="btn-gold w-full" onclick="salvarEmpresa()">SALVAR CONFIGURAÇÕES</button>
        </div>
    </section>

    <section id="categorias">
        <div class="card mb-4">
            <input id="newCatName" placeholder="Nome da Categoria">
            <input id="newCatImg" placeholder="Link da Imagem">
            <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
        </div>
        <div id="listaCategorias" class="grid gap-2"></div>
    </section>

    <section id="produtos">
        <div class="card mb-4">
            <h2 class="text-[#c5a059] font-bold uppercase text-xs mb-2">Novo Produto</h2>
            <input id="p-name" placeholder="Nome do Produto">
            <div class="grid grid-cols-2 gap-2">
                <input id="p-price" type="number" step="0.01" placeholder="Preço (0.00)">
                <input id="p-sku" placeholder="Referência/SKU">
            </div>
            <input id="p-img" placeholder="Link da Foto">
            <select id="p-cat"></select>
            <button class="btn-gold w-full" onclick="addProd()">SALVAR PRODUTO</button>
        </div>
        <div id="listaProdutos" class="grid gap-2"></div>
    </section>

    <section id="promocoes">
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-[#c5a059] font-bold uppercase text-sm">Gestão de Descontos</h2>
                <button id="btnStatusPromo" onclick="togglePromoStatus()" class="btn-gold px-4 py-1 text-[10px]">INATIVA</button>
            </div>
            
            <h3 class="text-[11px] font-bold text-navy uppercase mb-4 border-b pb-2">Promoção por Categoria</h3>
            <div id="containerPromocoes"></div>

            <h3 class="text-[11px] font-bold text-navy uppercase mt-10 mb-4 border-b pb-2">Ajuste de Produto Individual</h3>
            <div id="containerPromoProdutos" class="space-y-2">
                </div>
            
            <button class="btn-gold w-full mt-6" onclick="salvarPromocoes()">APLICAR TODAS AS PROMOÇÕES</button>
        </div>
    </section>

    <section id="pedidos">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>
</main>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyD62Yef2ggoAFSc-qKPlBTaRPRn20D91ug",
    databaseURL: "https://luary-shop-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    
    if (id === 'categorias') carregarCategorias();
    if (id === 'produtos') { carregarCategoriasSelect(); carregarProdutos(); }
    if (id === 'promocoes') carregarPainelPromocoes();
    if (id === 'pedidos') carregarPedidos();
}

/* --- LOGICA DE PROMOÇÕES ATUALIZADA --- */

async function carregarPainelPromocoes() {
    const containerCat = document.getElementById('containerPromocoes');
    const containerProd = document.getElementById('containerPromoProdutos');
    
    try {
        // Carrega Status Global
        const settingsSnap = await db.ref('settings/promocoes').once('value');
        const settings = settingsSnap.val() || { ativa: false };
        const btnStatus = document.getElementById('btnStatusPromo');
        btnStatus.innerText = settings.ativa ? 'ATIVA' : 'INATIVA';
        btnStatus.style.background = settings.ativa ? '#10b981' : '#1a2a3a';

        // Carrega Categorias
        const catSnap = await db.ref('categories').once('value');
        containerCat.innerHTML = '';
        catSnap.forEach(snap => {
            const cat = snap.val();
            containerCat.innerHTML += `
                <div class="promo-row" data-id="${snap.key}" data-type="category">
                    <span class="text-[11px] font-bold truncate">${cat.name}</span>
                    <input type="number" class="p-promo-pct" value="${cat.promoPct || 0}">
                    <input type="text" class="p-promo-tag" value="${cat.promoTag || ''}" placeholder="Tag">
                    <input type="color" class="p-promo-color h-8" value="${cat.promoColor || '#c5a059'}">
                </div>`;
        });

        // Carrega Produtos para Promo Individual
        const prodSnap = await db.ref('products').once('value');
        containerProd.innerHTML = '';
        prodSnap.forEach(snap => {
            const p = snap.val();
            containerProd.innerHTML += `
                <div class="card flex justify-between items-center text-[10px] promo-prod-row" data-id="${snap.key}">
                    <span>${p.name}</span>
                    <div class="flex gap-2 items-center">
                        <span>Desc %:</span>
                        <input type="number" class="p-prod-desc w-16 mb-0" value="${p.promoPct || 0}">
                    </div>
                </div>`;
        });
    } catch (e) { console.error(e); }
}

async function salvarPromocoes() {
    const updates = {};
    
    // Updates Categorias
    document.querySelectorAll('.promo-row').forEach(row => {
        const id = row.dataset.id;
        updates[`categories/${id}/promoPct`] = parseInt(row.querySelector('.p-promo-pct').value) || 0;
        updates[`categories/${id}/promoTag`] = row.querySelector('.p-promo-tag').value;
        updates[`categories/${id}/promoColor`] = row.querySelector('.p-promo-color').value;
    });

    // Updates Produtos Individuais
    document.querySelectorAll('.promo-prod-row').forEach(row => {
        const id = row.dataset.id;
        updates[`products/${id}/promoPct`] = parseInt(row.querySelector('.p-prod-desc').value) || 0;
    });

    await db.ref().update(updates);
    alert("Promoções e descontos de produtos salvos!");
}

/* --- FUNÇÕES EMPRESA ATUALIZADAS --- */

function carregarEmpresa() {
    db.ref('settings/empresa').once('value', s => {
        const v = s.val() || {};
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empSub').value = v.subtitulo || '';
        document.getElementById('empWhats').value = v.whats || '';
        document.getElementById('empDescPix').value = v.descPix || 0;
        document.getElementById('empParcelas').value = v.parcelas || 1;
    });
}

function salvarEmpresa() {
    // Pegando os valores dos campos
    const nome = document.getElementById('empNome').value;
    const sub = document.getElementById('empSub').value;
    const whats = document.getElementById('empWhats').value;
    const pix = parseInt(document.getElementById('empDescPix').value) || 0;
    const parc = parseInt(document.getElementById('empParcelas').value) || 1;

    if(!nome) { alert("Digite o nome da loja!"); return; }

    const dados = {
        nome: nome,
        subtitulo: sub,
        whats: whats,
        descPix: pix,
        parcelas: parc
    };

    // O comando .set FORÇA a criação da pasta no banco
    db.ref('settings/empresa').set(dados)
    .then(() => {
        alert('✅ Árvore criada com sucesso! Verifique seu Firebase.');
        console.log("Sucesso ao enviar para o Firebase:", dados);
    })
    .catch((error) => {
        alert('❌ Erro de permissão! Verifique as Rules do Firebase.');
        console.error("Erro detalhado:", error);
    });
}

/* --- AUXILIARES --- */
function togglePromoStatus() {
    const btn = document.getElementById('btnStatusPromo');
    const novoStatus = btn.innerText === 'INATIVA';
    db.ref('settings/promocoes/ativa').set(novoStatus).then(() => {
        btn.innerText = novoStatus ? 'ATIVA' : 'INATIVA';
        btn.style.background = novoStatus ? '#10b981' : '#1a2a3a';
    });
}

function carregarCategorias() {
    db.ref('categories').on('value', s => {
        const lista = document.getElementById('listaCategorias');
        lista.innerHTML = '';
        s.forEach(c => {
            lista.innerHTML += `<div class="card flex justify-between items-center">
                <span class="uppercase text-xs font-bold">${c.val().name}</span>
                <button class="btn text-red-500 font-bold" onclick="excluirItem('categories/${c.key}')">Excluir</button>
            </div>`;
        });
    });
}

function carregarCategoriasSelect() {
    db.ref('categories').once('value', s => {
        const sel = document.getElementById('p-cat');
        sel.innerHTML = '';
        s.forEach(c => { sel.innerHTML += `<option value="${c.key}">${c.val().name}</option>`; });
    });
}

function addProd() {
    const p = {
        name: document.getElementById('p-name').value,
        price: Number(document.getElementById('p-price').value),
        sku: document.getElementById('p-sku').value,
        image: document.getElementById('p-img').value,
        category: document.getElementById('p-cat').value
    };
    db.ref('products').push(p).then(() => alert("Produto salvo!"));
}

function carregarProdutos() {
    db.ref('products').on('value', s => {
        const lista = document.getElementById('listaProdutos');
        lista.innerHTML = '';
        s.forEach(p => {
            const prod = p.val();
            lista.innerHTML += `<div class="card flex justify-between items-center text-[10px]">
                <span><b>${prod.sku}</b> - ${prod.name}</span>
                <button class="text-red-400 font-bold" onclick="excluirItem('products/${p.key}')">X</button>
            </div>`;
        });
    });
}

function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '';
        s.forEach(ped => {
            const p = ped.val();
            lista.innerHTML += `<div class="card border-l-4 border-[#c5a059] text-xs">
                <b>${p.cliente?.nome || 'Cliente'}</b> - ${fMoeda(p.total)}
                <button class="btn text-red-500 float-right" onclick="excluirItem('orders/${ped.key}')">Arquivar</button>
            </div>`;
        });
    });
}

function novaCategoria() {
    const n = document.getElementById('newCatName').value;
    const i = document.getElementById('newCatImg').value;
    if(n) db.ref('categories').push({name:n, image:i, promoPct: 0});
}

function excluirItem(path) { if(confirm("Confirmar exclusão?")) db.ref(path).remove(); }

window.onload = carregarEmpresa;
</script>
</body>
</html>
