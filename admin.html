<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo â€¢ Luary Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { background:#0b0b0b; color:#eee; font-family:Inter,Arial; margin:0; }
        nav button.active { border-bottom:2px solid #caa85c; color:#caa85c; }
        section { display:none; min-height:300px; }
        section.active { display:block; }
        .card { background:#141414; border:1px solid #2a2a2a; border-radius:16px; padding:14px; }
        .btn { background:#222; border:1px solid #444; padding:8px 12px; border-radius:8px; font-size:11px; cursor:pointer; }
        .btn-gold { background:#caa85c; color:#000; font-weight:700; padding:10px; border-radius:8px; cursor:pointer; text-transform: uppercase; font-size: 11px; text-align: center; width: 100%; border:none; }
        input { background:#111; border:1px solid #333; padding:8px; border-radius:8px; width:100%; margin-bottom:8px; color:#fff; outline:none; font-size: 12px; }
        label { font-size: 10px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; display: block; }
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; background: #fff; color: #000; }
        }
        #mainModal.active { display: flex; }
    </style>
</head>
<body>

<header class="p-5 text-center bg-black border-b border-[#222]">
    <h1 class="text-[#caa85c] font-black text-xl tracking-[0.2em] uppercase">Luary Shop â€¢ Admin</h1>
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
    <button type="button" class="btn active" onclick="showTab('pedidos', this)">Pedidos</button>
    <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
    <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
    <button type="button" class="btn" onclick="showTab('promocoes', this)">PromoÃ§Ãµes</button>
    <button type="button" class="btn" onclick="showTab('empresa', this)">Empresa</button>
</nav>

<main class="p-6 max-w-5xl mx-auto">
    <section id="pedidos" class="active"><div id="listaPedidos" class="grid gap-4"></div></section>
    <section id="produtos"><div id="listaProdutos" class="grid gap-2"></div></section>
    <section id="categorias">
        <div class="card mb-4">
            <input id="newCatName" placeholder="Nome da Categoria">
            <button class="btn-gold" onclick="novaCategoria()">ADICIONAR CATEGORIA</button>
        </div>
        <div id="listaCategorias" class="grid gap-2"></div>
    </section>
    <section id="promocoes">
        <div class="card text-center space-y-6 p-8">
            <label>Status Global da PromoÃ§Ã£o</label>
            <button id="btnStatusPromo" onclick="togglePromoStatus()" class="btn">CARREGANDO...</button>
            <button class="btn-gold" onclick="abrirPainelPromocoes()">EDITAR CAMPANHAS POR CATEGORIA</button>
        </div>
    </section>
    <section id="empresa">
        <div class="card space-y-3">
            <input id="empNome" placeholder="Nome da Loja">
            <input id="empSub" placeholder="Slogan">
            <input id="empWhats" placeholder="WhatsApp">
            <input id="empDesc" type="number" placeholder="Desc. PIX %">
            <input id="empParc" type="number" placeholder="Parcelas">
            <button class="btn-gold" onclick="salvarEmpresa()">SALVAR DADOS</button>
        </div>
    </section>
</main>

<div id="mainModal" class="fixed inset-0 bg-black/95 z-[200] hidden items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-4xl rounded-3xl flex flex-col max-h-[90vh]">
        <div class="p-5 border-b border-[#222] flex justify-between items-center">
            <h3 id="modalTitle" class="text-[#caa85c] font-black uppercase text-sm">Editor</h3>
            <button onclick="fecharModal()" class="text-gray-500 text-3xl">&times;</button>
        </div>
        <div id="modalBody" class="p-6 overflow-y-auto"></div>
        <div class="p-5 border-t border-[#222]">
            <button id="modalSaveBtn" class="btn-gold">SALVAR TUDO</button>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyD62Yef2ggoAFSc-qKPlBTaRPRn20D91ug",
    databaseURL: "https://luary-shop-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let pedidoEditando = null;
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id === 'pedidos') carregarPedidos();
    if(id === 'categorias') carregarCategorias();
    if(id === 'produtos') carregarProdutos();
}

function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const container = document.getElementById('listaPedidos');
        container.innerHTML = '';
        s.forEach(c => {
            const p = c.val();
            container.innerHTML += `<div class="card flex justify-between items-center border-l-4 border-[#caa85c]">
                <div><b>${p.cliente?.nome || 'Cliente'}</b><br><small>${p.data || ''}</small></div>
                <div class="flex gap-2">
                    <button class="btn" onclick="abrirEditorPedido('${c.key}')">EDITAR</button>
                    <button class="btn text-red-500" onclick="excluirPedido('${c.key}')">ðŸ—‘</button>
                </div>
            </div>`;
        });
    });
}

function carregarCategorias() {
    db.ref('categories').on('value', s => {
        const lista = document.getElementById('listaCategorias');
        lista.innerHTML = '';
        s.forEach(c => {
            lista.innerHTML += `<div class="card flex justify-between items-center mb-2">
                <span class="uppercase text-xs font-bold">${c.val().name}</span>
                <button class="btn text-red-500" onclick="db.ref('categories/${c.key}').remove()">ðŸ—‘</button>
            </div>`;
        });
    });
}

function carregarProdutos() {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = 'Carregando...';
    db.ref('categories').once('value', sCats => {
        db.ref('products').once('value', sProds => {
            lista.innerHTML = '';
            sCats.forEach(cat => {
                let htmlP = '';
                sProds.forEach(p => {
                    const prod = p.val();
                    if(prod.category === cat.key) {
                        htmlP += `<div class="card flex justify-between items-center mb-1 text-[11px] bg-black/20">
                            <span><b>[${prod.sku || '---'}]</b> ${prod.name}</span>
                        </div>`;
                    }
                });
                if(htmlP) lista.innerHTML += `<div class="mb-4"><b class="text-[#caa85c] uppercase text-[10px]">${cat.val().name}</b>${htmlP}</div>`;
            });
        });
    });
}

function abrirEditorPedido(id) {
    pedidoEditando = id;
    db.ref('orders/' + id).once('value', s => {
        const p = s.val();
        document.getElementById('modalTitle').innerText = 'EDITANDO PEDIDO';
        document.getElementById('modalBody').innerHTML = `
            <label>Cliente</label><input id="edNome" value="${p.cliente?.nome || ''}">
            <label>WhatsApp</label><input id="edTel" value="${p.cliente?.telefone || ''}">
            <div class="grid grid-cols-2 gap-2 mt-4">
                <button class="btn bg-zinc-800" onclick="imprimirRomaneio('${id}', 1)">LISTA SIMPLES</button>
                <button class="btn bg-blue-900" onclick="imprimirRomaneio('${id}', 6)">GRID C/ FOTOS</button>
            </div>`;
        document.getElementById('mainModal').classList.add('active');
        document.getElementById('modalSaveBtn').onclick = () => {
            db.ref('orders/' + id + '/cliente').update({ nome: document.getElementById('edNome').value, telefone: document.getElementById('edTel').value })
            .then(() => { alert("Salvo!"); fecharModal(); });
        };
    });
}

function imprimirRomaneio(id, tipo) {
    db.ref('orders/'+id).once('value', sP => {
        db.ref('settings/empresa').once('value', sE => {
            const p = sP.val(); const e = sE.val() || {};
            const itens = p.itens ? Object.values(p.itens) : [];
            const isGrid = [4,5,6].includes(tipo);
            let html = `<div style="padding:10mm; font-family:Arial;">
                <h1 style="text-align:center; border-bottom:2px solid #000;">${e.nome || 'LUARY SHOP'}</h1>
                <p><b>CLIENTE:</b> ${p.cliente?.nome}</p>`;
            if(isGrid) {
                html += `<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;">`;
                itens.forEach(i => html += `<div style="border:1px solid #000; padding:5px; text-align:center;"><b>${i.sku}</b><br>${i.name}<br>QTD: ${i.quantidade}</div>`);
                html += `</div>`;
            } else {
                itens.forEach(i => html += `<p>${i.quantidade}x ${i.sku} - ${i.name}</p>`);
            }
            html += `</div>`;
            document.getElementById('print-area').innerHTML = html;
            setTimeout(() => { window.print(); }, 500);
        });
    });
}

function togglePromoStatus() {
    db.ref('settings/promocao/ativa').once('value', s => db.ref('settings/promocao/ativa').set(!s.val()));
}

function salvarEmpresa() {
    db.ref('settings/empresa').update({
        nome: document.getElementById('empNome').value,
        whats: document.getElementById('empWhats').value,
        descontoPix: +document.getElementById('empDesc').value
    }).then(() => alert("Salvo!"));
}

function novaCategoria() {
    const name = document.getElementById('newCatName').value;
    if(name) db.ref('categories').push({name}).then(() => document.getElementById('newCatName').value = '');
}

function fecharModal() { document.getElementById('mainModal').classList.remove('active'); }
function excluirPedido(id) { if(confirm('Excluir?')) db.ref('orders/' + id).remove(); }

window.onload = () => {
    carregarPedidos();
    db.ref('settings/promocao/ativa').on('value', s => {
        const b = document.getElementById('btnStatusPromo');
        if(b) b.innerText = s.val() ? 'ATIVA' : 'INATIVA';
    });
};
</script>
</body>
</html>
