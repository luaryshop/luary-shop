<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo ‚Ä¢ Luary Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body { background:#0b0b0b; color:#eee; font-family:Inter,Arial; margin:0; }
        nav button.active { border-bottom:2px solid #caa85c; color:#caa85c; }
        section { display:none; min-height:300px; }
        section.active { display:block; }
        .card { background:#141414; border:1px solid #2a2a2a; border-radius:16px; padding:14px; }
        .btn { background:#222; border:1px solid #444; padding:8px 12px; border-radius:8px; font-size:11px; cursor:pointer; transition: 0.3s; }
        .btn:hover { background:#333; }
        .btn-gold { background:#caa85c; color:#000; font-weight:700; padding:10px; border-radius:8px; cursor:pointer; text-transform: uppercase; font-size: 11px; text-align: center; }
        input, select { background:#111; border:1px solid #333; padding:8px; border-radius:8px; width:100%; margin-bottom:8px; color:#fff; outline:none; font-size: 12px; }
        label { font-size: 10px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; display: block; }
        
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; background: #fff; color: #000; z-index: 9999; }
        }
        
        #mainModal.active { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #caa85c; border-radius: 10px; }
    </style>
</head>
<body>

<header class="p-5 text-center bg-black border-b border-[#222]">
    <h1 class="text-[#caa85c] font-black text-xl tracking-[0.2em] uppercase">Luary Shop ‚Ä¢ Admin</h1>
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
    <button type="button" class="btn active" onclick="showTab('pedidos', this)">Pedidos</button>
    <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
    <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
    <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
    <button type="button" class="btn" onclick="showTab('empresa', this)">Empresa</button>
</nav>

<main class="p-6 max-w-5xl mx-auto">
    <section id="pedidos" class="active">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>

    <section id="produtos">
        <div id="listaProdutos" class="grid gap-2"></div>
    </section>

    <section id="categorias">
        <div class="card mb-4">
            <input id="newCatName" placeholder="Nome da Categoria">
            <button class="btn-gold w-full" onclick="novaCategoria()">ADICIONAR CATEGORIA</button>
        </div>
        <div id="listaCategorias" class="grid gap-2"></div>
    </section>

    <section id="promocoes">
        <div class="card text-center space-y-6 p-8">
            <h2 class="text-[#caa85c] font-bold uppercase tracking-widest">Controle de Ofertas</h2>
            <div class="bg-black/40 p-6 rounded-2xl border border-white/5">
                <label>Status Global da Promo√ß√£o</label>
                <button id="btnStatusPromo" onclick="togglePromoStatus()" class="px-10 py-3 mt-2 rounded-xl font-black text-xs transition-all border border-white/10">CARREGANDO...</button>
            </div>
            <button class="btn-gold w-full py-5 text-sm" onclick="abrirPainelPromocoes()">üé® EDITAR CAMPANHAS POR CATEGORIA</button>
        </div>
    </section>

    <section id="empresa">
        <div class="card space-y-3">
            <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√µes da Empresa</h2>
            <input id="empNome" placeholder="Nome da Loja">
            <input id="empSub" placeholder="Slogan">
            <input id="empWhats" placeholder="WhatsApp (55...)">
            <div class="grid grid-cols-2 gap-2">
                <div><label>Desc. PIX %</label><input id="empDesc" type="number"></div>
                <div><label>Parcelas</label><input id="empParc" type="number"></div>
            </div>
            <button class="btn-gold w-full" onclick="salvarEmpresa()">SALVAR DADOS</button>
        </div>
    </section>
</main>

<div id="mainModal" class="fixed inset-0 bg-black/95 z-[200] hidden items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-4xl rounded-3xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="p-5 border-b border-[#222] flex justify-between items-center bg-black/50">
            <h3 id="modalTitle" class="text-[#caa85c] font-black uppercase text-sm">Editor</h3>
            <button onclick="fecharModal()" class="text-gray-500 text-3xl">&times;</button>
        </div>
        <div id="modalBody" class="p-6 overflow-y-auto custom-scroll"></div>
        <div class="p-5 border-t border-[#222] bg-black/50">
            <button id="modalSaveBtn" class="btn-gold w-full py-4 text-sm">SALVAR TUDO</button>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyD62Yef2ggoAFSc-qKPlBTaRPRn20D91ug",
    databaseURL: "https://luary-shop-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pedidoEditando = null;
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id === 'pedidos') carregarPedidos();
}

function carregarPedidos() {
    db.ref('orders').on('value', snapshot => {
        const container = document.getElementById('listaPedidos');
        container.innerHTML = '';
        snapshot.forEach(child => {
            const p = child.val();
            container.innerHTML += `
                <div class="card flex justify-between items-center border-l-4 border-[#caa85c]">
                    <div>
                        <b class="text-[#caa85c] text-sm uppercase">${p.cliente?.nome || 'Cliente'}</b><br>
                        <small class="text-gray-500">${p.data}</small>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn" onclick="abrirEditorPedido('${child.key}')">EDITAR</button>
                        <button class="btn bg-red-900" onclick="excluirPedido('${child.key}')">üóë</button>
                    </div>
                </div>`;
        });
    });
}

function abrirEditorPedido(id) {
    pedidoEditando = id;
    db.ref('orders/' + id).once('value', snapshot => {
        const p = snapshot.val();
        document.getElementById('modalTitle').innerText = 'EDITANDO PEDIDO';
        document.getElementById('modalBody').innerHTML = `
            <div class="grid md:grid-cols-2 gap-4">
                <div class="card bg-white/5">
                    <label>Cliente</label><input id="edClienteNome" value="${p.cliente?.nome || ''}">
                    <label>WhatsApp</label><input id="edClienteTel" value="${p.cliente?.telefone || ''}">
                </div>
                <div class="card bg-white/5">
                    <label>Destinat√°rio</label><input id="edNomeEntrega" value="${p.entrega?.nomeEntrega || ''}">
                    <label>Rua/N¬∫</label><input id="edRua" value="${p.entrega?.rua || ''}">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="edBairro" placeholder="Bairro" value="${p.entrega?.bairro || ''}">
                        <input id="edCidade" placeholder="Cidade" value="${p.entrega?.cidade || ''}">
                    </div>
                    <label>CEP</label><input id="edCep" value="${p.entrega?.cep || ''}">
                </div>
            </div>
            <div class="mt-4">
                <label>Itens</label>
                <div id="edItens" class="space-y-2"></div>
                <button class="btn w-full mt-2" onclick="addItemEditor()">+ ITEM</button>
            </div>
            <div class="grid grid-cols-3 gap-2 mt-4 p-4 bg-black/40 rounded-xl">
                <div><label>Desc Promo</label><input id="edDescPromo" type="number" step="0.01" value="${p.descontoPromo || 0}"></div>
                <div><label>Desc PIX</label><input id="edDescPix" type="number" step="0.01" value="${p.descontoPix || 0}"></div>
                <div><label>Frete</label><input id="edFrete" type="number" step="0.01" value="${p.frete || 0}"></div>
            </div>
            <div class="mt-6 border-t border-white/10 pt-4">
                <p class="text-[10px] text-gray-500 uppercase mb-4 text-center">Imprimir Romaneio</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <button class="btn bg-zinc-800" onclick="imprimirRomaneio('${id}', 1)">CONFER√äNCIA (LISTA)</button>
                    <button class="btn bg-zinc-800" onclick="imprimirRomaneio('${id}', 2)">FINANCEIRO (LISTA)</button>
                    <button class="btn bg-zinc-800" onclick="imprimirRomaneio('${id}', 3)">FOTOS (LISTA)</button>
                    <button class="btn bg-blue-900" onclick="imprimirRomaneio('${id}', 4)">CONFER√äNCIA (GRID)</button>
                    <button class="btn bg-blue-900" onclick="imprimirRomaneio('${id}', 5)">FINANCEIRO (GRID)</button>
                    <button class="btn bg-blue-900" onclick="imprimirRomaneio('${id}', 6)">FOTOS (GRID)</button>
                </div>
            </div>`;

        const itens = p.itens ? (Array.isArray(p.itens) ? p.itens : Object.values(p.itens)) : [];
        itens.forEach(i => addItemEditor(i));
        document.getElementById('mainModal').classList.add('active');
        document.getElementById('modalSaveBtn').onclick = salvarPedidoEditado;
    });
}

function addItemEditor(i = {}) {
    const div = document.createElement('div');
    div.className = "grid grid-cols-4 gap-2 bg-black/50 p-2 rounded";
    div.innerHTML = `
        <input placeholder="SKU" value="${i.sku||''}">
        <input placeholder="Nome" value="${i.name||''}">
        <input type="number" placeholder="Pre√ßo" value="${i.price||0}">
        <input type="number" placeholder="Qtd" value="${i.quantidade||1}">
        <button class="text-red-500 text-[10px] col-span-4 text-left" onclick="this.parentElement.remove()">REMOVER</button>`;
    document.getElementById('edItens').appendChild(div);
}

function salvarPedidoEditado() {
    const itens = [];
    let subtotal = 0;
    document.querySelectorAll('#edItens > div').forEach(div => {
        const ins = div.querySelectorAll('input');
        if(ins.length >= 4){
            const item = { sku: ins[0].value, name: ins[1].value, price: +ins[2].value, quantidade: +ins[3].value };
            subtotal += (item.price * item.quantidade);
            itens.push(item);
        }
    });
    db.ref('orders/' + pedidoEditando).update({
        cliente: { nome: document.getElementById('edClienteNome').value, telefone: document.getElementById('edClienteTel').value },
        entrega: { 
            nomeEntrega: document.getElementById('edNomeEntrega').value, 
            rua: document.getElementById('edRua').value, 
            bairro: document.getElementById('edBairro').value, 
            cidade: document.getElementById('edCidade').value,
            cep: document.getElementById('edCep').value 
        },
        itens, subtotal,
        descontoPromo: +document.getElementById('edDescPromo').value,
        descontoPix: +document.getElementById('edDescPix').value,
        frete: +document.getElementById('edFrete').value,
        total: subtotal - +document.getElementById('edDescPromo').value - +document.getElementById('edDescPix').value + +document.getElementById('edFrete').value
    }).then(() => { alert("Pedido salvo!"); fecharModal(); });
}

function abrirPainelPromocoes() {
    db.ref('categories').once('value', snapshot => {
        let html = '';
        snapshot.forEach(cat => {
            const c = cat.val();
            html += `
            <div class="card border-white/5 p-4 mb-4 bg-black/40">
                <span class="text-[#caa85c] font-black uppercase text-xs">${c.name}</span>
                <div class="grid grid-cols-2 gap-4 mt-2">
                    <div><label>Nome Campanha</label><input id="p_name_${cat.key}" value="${c.promoName||''}"></div>
                    <div><label>Texto Tag</label><input id="p_tag_${cat.key}" value="${c.promoTag||''}"></div>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-2">
                    <div><label>% Desc.</label><input id="p_pct_${cat.key}" type="number" value="${c.promoPct||0}"></div>
                    <div><label>Cor Tag</label><input id="p_color_${cat.key}" type="color" value="${c.promoColor||'#caa85c'}"></div>
                    <div><label>Cor Texto</label><input id="p_tcolor_${cat.key}" type="color" value="${c.promoTextColor||'#ffffff'}"></div>
                </div>
            </div>`;
        });
        document.getElementById('modalTitle').innerText = 'EDITAR PROMO√á√ïES POR CATEGORIA';
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('mainModal').classList.add('active');
        document.getElementById('modalSaveBtn').onclick = () => {
            const updates = {};
            snapshot.forEach(cat => {
                updates['categories/' + cat.key + '/promoPct'] = +document.getElementById('p_pct_' + cat.key).value || 0;
                updates['categories/' + cat.key + '/promoName'] = document.getElementById('p_name_' + cat.key).value;
                updates['categories/' + cat.key + '/promoTag'] = document.getElementById('p_tag_' + cat.key).value;
                updates['categories/' + cat.key + '/promoColor'] = document.getElementById('p_color_' + cat.key).value;
                updates['categories/' + cat.key + '/promoTextColor'] = document.getElementById('p_tcolor_' + cat.key).value;
            });
            db.ref().update(updates).then(() => { alert("Salvo!"); fecharModal(); });
        };
    });
}

function imprimirRomaneio(id, tipo) {
    db.ref('orders/' + id).once('value', sPed => {
        db.ref('settings/empresa').once('value', sEmp => {
            const p = sPed.val(); 
            const emp = sEmp.val() || { nome: "LUARY SHOP" };
            const itens = p.itens ? (Array.isArray(p.itens) ? p.itens : Object.values(p.itens)) : [];
            
            // Configura√ß√µes de exibi√ß√£o baseadas no tipo (1 a 6)
            const isFin = [2, 3, 5, 6].includes(tipo);    // Tipos que mostram valores
            const isGrid = [4, 5, 6].includes(tipo);     // Tipos que usam layout de grade
            const showFoto = [3, 6].includes(tipo);      // Tipos que mostram imagem do produto

            let html = `
            <div style="padding:10mm; font-family:Arial; background:#fff; color:#000;">
                <h1 style="text-align:center; border-bottom:2px solid #000; padding-bottom:5px; text-transform:uppercase;">${emp.nome || 'LUARY SHOP'}</h1>
                
                <div style="display:flex; justify-content:space-between; margin:15px 0; gap: 10px;">
                    <div style="border:1px solid #000; padding:10px; width:48%; font-size:12px;">
                        <b style="color:#96793a; font-size:10px; text-transform:uppercase;">Dados do Cliente</b><br>
                        <b>NOME:</b> ${p.cliente?.nome || 'N√£o informado'}<br>
                        <b>WHATS:</b> ${p.cliente?.telefone || 'N√£o informado'}
                    </div>
                    <div style="border:1px solid #000; padding:10px; width:48%; font-size:12px;">
                        <b style="color:#96793a; font-size:10px; text-transform:uppercase;">Local de Entrega</b><br>
                        <b>DESTINAT√ÅRIO:</b> ${p.entrega?.nomeEntrega || p.cliente?.nome || 'O Pr√≥prio'}<br>
                        <b>ENDERE√áO:</b> ${p.entrega?.rua || ''}, ${p.entrega?.bairro || ''}<br>
                        ${p.entrega?.cidade || ''} - CEP: ${p.entrega?.cep || ''}
                    </div>
                </div>`;

            if (!isGrid) {
                // Layout em LISTA (Tabela)
                html += `<table style="width:100%; border-collapse:collapse; font-size:11px;">
                    <thead style="background:#eee;">
                        <tr>
                            ${showFoto ? '<th style="border:1px solid #000; padding:5px; width:60px;">FOTO</th>' : ''}
                            <th style="border:1px solid #000; padding:5px; text-align:left;">PRODUTO</th>
                            <th style="border:1px solid #000; padding:5px; width:50px;">QTD</th>
                            ${isFin ? '<th style="border:1px solid #000; padding:5px; text-align:right; width:90px;">VALOR</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>`;
                
                itens.forEach(i => {
                    html += `<tr>
                        ${showFoto ? `<td style="border:1px solid #000; text-align:center; padding:2px;"><img src="${i.image || ''}" style="width:50px; height:50px; object-fit:contain;"></td>` : ''}
                        <td style="border:1px solid #000; padding:5px;"><b>${i.sku || '---'}</b> - ${i.name}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:center;">${i.quantidade}</td>
                        ${isFin ? `<td style="border:1px solid #000; padding:5px; text-align:right;">${fMoeda(i.price * i.quantidade)}</td>` : ''}
                    </tr>`;
                });
                html += `</tbody></table>`;
            } else {
                // Layout em GRID (Cart√µes)
                html += `<div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">`;
                itens.forEach(i => {
                    html += `<div style="border:1px solid #000; padding:8px; text-align:center; font-size:10px; border-radius:5px;">
                        ${showFoto ? `<img src="${i.image || ''}" style="width:100%; height:80px; object-fit:contain; margin-bottom:5px;">` : ''}
                        <b style="font-size:11px;">${i.sku || '---'}</b><br>
                        <span style="display:block; height:24px; overflow:hidden;">${i.name}</span>
                        <div style="margin-top:5px; border-top:1px dashed #ccc; pt-2">
                            <b>QTD: ${i.quantidade}</b>
                            ${isFin ? `<br><b style="font-size:12px; color:#96793a;">${fMoeda(i.price * i.quantidade)}</b>` : ''}
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }

            // Rodap√© Financeiro
            if (isFin) {
                html += `
                <div style="margin-top:20px; text-align:right; font-size:13px; border:2px solid #000; padding:15px; border-radius:10px;">
                    Subtotal: ${fMoeda(p.subtotal)}<br>
                    Frete: ${fMoeda(p.frete || 0)}<br>
                    Descontos: - ${fMoeda((p.descontoPromo || 0) + (p.descontoPix || 0))}<br>
                    <b style="font-size:18px; color:#000;">TOTAL DO PEDIDO: ${fMoeda(p.total)}</b>
                </div>`;
            }
            
            html += `
                <div style="margin-top:20px; font-size:10px; text-align:center; color:#666;">
                    Documento gerado em ${new Date().toLocaleString('pt-BR')} - Luary Shop
                </div>
            </div>`;

            document.getElementById('print-area').innerHTML = html;
            
            // Aguarda carregar imagens antes de abrir a janela de impress√£o
            setTimeout(() => { 
                window.print(); 
            }, 700);
        });
    });
}

function togglePromoStatus() {
    db.ref('settings/promocao/ativa').once('value', s => {
        db.ref('settings/promocao/ativa').set(!s.val());
    });
}

function salvarEmpresa() {
    db.ref('settings/empresa').update({
        nome: document.getElementById('empNome').value,
        subtitulo: document.getElementById('empSub').value,
        whats: document.getElementById('empWhats').value,
        descontoPix: +document.getElementById('empDesc').value,
        parcelas: +document.getElementById('empParc').value
    }).then(() => alert("Dados salvos!"));
}

function fecharModal() { document.getElementById('mainModal').classList.remove('active'); }
function excluirPedido(id) { if(confirm('Excluir pedido?')) db.ref('orders/' + id).remove(); }
function novaCategoria() {
    const name = document.getElementById('newCatName').value;
    if(name) db.ref('categories').push({name}).then(() => document.getElementById('newCatName').value = '');
}
function carregarCategorias() {
    db.ref('categories').on('value', s => {
        const lista = document.getElementById('listaCategorias');
        if (!lista) return; // Prote√ß√£o contra erro de elemento inexistente
        lista.innerHTML = '';
        s.forEach(c => {
            const cat = c.val();
            lista.innerHTML += `<div class="card flex justify-between items-center mb-2">
                <span class="uppercase text-xs font-bold">${cat.name}</span>
                <div class="flex gap-2">
                    <button class="btn text-blue-400" onclick="editarCat('${c.key}','${cat.name}')">‚úé</button>
                    <button class="btn text-red-500" onclick="excluirCat('${c.key}')">üóë</button>
                </div>
            </div>`;
        });
    }); [cite: 53, 54]
}
}
function carregarProdutos() {
    const lista = document.getElementById('listaProdutos');
    if (!lista) return;
    lista.innerHTML = '<p class="text-center p-4">Carregando produtos...</p>';
    
    db.ref('categories').once('value', sCats => {
        db.ref('products').once('value', sProds => {
            lista.innerHTML = '';
            sCats.forEach(cat => {
                let htmlP = '';
                sProds.forEach(p => {
                    const prod = p.val();
                    if(prod.category === cat.key) { // Verifica se o produto pertence a esta categoria
                        htmlP += `<div class="card flex justify-between items-center py-2 px-3 bg-[#0d0d0d] mb-1 text-[11px]">
                            <div class="flex items-center gap-3">
                                <img src="${prod.image || ''}" class="w-8 h-8 object-cover rounded border border-[#333]">
                                <span><b class="text-[#caa85c]">[${prod.sku || '---'}]</b> ${prod.name}</span>
                            </div>
                            <button onclick="editarProduto('${p.key}')" class="btn">‚úé</button>
                        </div>`;
                    }
                });
                if(htmlP) {
                    lista.innerHTML += `<div class="mb-4">
                        <b class="text-[10px] text-[#caa85c] ml-1 uppercase">${cat.val().name}</b>
                        <div class="mt-1">${htmlP}</div>
                    </div>`;
                }
            });
        });
    }); [cite: 57, 58, 59, 61]
}
window.onload = () => {
    carregarPedidos();
    db.ref('settings/promocao/ativa').on('value', s => {
        const v = s.val(); const b = document.getElementById('btnStatusPromo');
        if(b) {
            b.innerText = v ? 'ATIVA' : 'INATIVA';
            b.className = `px-10 py-3 mt-2 rounded-xl font-black text-xs transition-all border ${v ? 'bg-green-900/20 text-green-500 border-green-500/20':'bg-red-900/20 text-red-500 border-red-500/20'}`;
        }
    });
    db.ref('settings/empresa').once('value', s => {
        const v = s.val() || {};
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empSub').value = v.subtitulo || '';
        document.getElementById('empWhats').value = v.whats || '';
        document.getElementById('empDesc').value = v.descontoPix || 0;
        document.getElementById('empParc').value = v.parcelas || 0;
    });
};
</script>
</body>
</html>
