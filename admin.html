<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo • Luary Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #d4af37; --dark: #0b0b0b; --card: #141414; }
        body { background: var(--dark); color: #eee; font-family: 'Inter', sans-serif; margin: 0; }
        .serif { font-family: 'Playfair Display', serif; }
        .card { background: var(--card); border: 1px solid #2a2a2a; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        input, select { background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; font-size: 13px; margin-top: 5px; }
        label { font-size: 10px; text-transform: uppercase; color: #666; font-weight: bold; margin-top: 10px; display: block; }
        .btn-gold { background: var(--gold); color: black; font-weight: bold; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; text-transform: uppercase; font-size: 11px; text-align: center; }
        
        nav button.active { color: var(--gold); border-bottom: 2px solid var(--gold); }
        section { display: none; }
        section.active { display: block; }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; display: block !important; }
        }
    </style>
</head>
<body>

<header class="p-6 border-b border-white/5 sticky top-0 bg-[#0b0b0b]/90 backdrop-blur-md z-50">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <h1 class="serif text-2xl text-[158]">Luary <span class="text-white text-[12px]">Admin</span></h1>
        <nav class="flex gap-4 md:gap-8 overflow-x-auto pb-2">
            <button onclick="tab('pedidos')" id="btn-pedidos" class="active font-bold text-[10px] uppercase">Pedidos</button>
            <button onclick="tab('promocoes')" id="btn-promocoes" class="font-bold text-[10px] uppercase">Promoções</button>
            <button onclick="tab('categorias')" id="btn-categorias" class="font-bold text-[10px] uppercase">Categorias</button>
            <button onclick="tab('empresa')" id="btn-empresa" class="font-bold text-[10px] uppercase">Empresa</button>
        </nav>
    </div>
</header>

<main class="max-w-4xl mx-auto p-6">

    <section id="pedidos" class="active">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>

    <section id="promocoes">
        <div class="card">
            <h2 class="serif text-xl mb-4 text-[#d4af37]">Painel de Ofertas</h2>
            <div id="listaPromos" class="space-y-4">
                </div>
            <button class="btn-gold mt-6" onclick="salvarPromocoes()">Salvar Todas as Promoções</button>
        </div>
    </section>

    <section id="empresa">
        <div class="card">
            <h2 class="serif text-xl mb-4">Configuração da Loja</h2>
            <input id="empNome" placeholder="Nome da Empresa">
            <input id="empWhats" placeholder="WhatsApp">
            <button class="btn-gold mt-4" onclick="salvarEmpresa()">Guardar Alterações</button>
        </div>
    </section>

</main>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4">
    <div class="bg-[#111] border border-[#2a2a2a] w-full max-w-4xl rounded-2xl p-6 overflow-y-auto max-h-[90vh]">
        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h2 class="serif text-gold text-xl">EDITAR PEDIDO</h2>
            <button onclick="fecharEditor()" class="text-white text-2xl">&times;</button>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="card !mb-0">
                <h3 class="text-[10px] text-gold font-bold uppercase mb-4">Dados do Cliente</h3>
                <input id="edClienteNome" placeholder="Nome do Cliente">
                <input id="edClienteTel" placeholder="WhatsApp">
            </div>
            <div class="card !mb-0">
                <h3 class="text-[10px] text-gold font-bold uppercase mb-4">Local de Entrega Completo</h3>
                <input id="edNomeEntrega" placeholder="Nome do Destinatário">
                <input id="edRua" placeholder="Rua e Número">
                <div class="grid grid-cols-2 gap-2">
                    <input id="edBairro" placeholder="Bairro">
                    <input id="edCidade" placeholder="Cidade">
                </div>
            </div>
        </div>

        <h3 class="text-[10px] text-gold font-bold uppercase mt-6 mb-2">Itens e Financeiro</h3>
        <div id="edItens" class="space-y-2"></div>

        <div class="grid grid-cols-3 gap-3 mt-6 p-4 bg-white/5 rounded-xl">
            <div><label>Desconto (R$)</label><input id="edDesc" type="number" oninput="recalcularTotalEd()"></div>
            <div><label>Frete (R$)</label><input id="edFrete" type="number" oninput="recalcularTotalEd()"></div>
            <div class="text-right">
                <label>Total Final</label>
                <div id="totalPreview" class="text-gold font-bold text-xl mt-2">R$ 0,00</div>
            </div>
        </div>

        <div class="flex gap-4 mt-8">
            <button onclick="fecharEditor()" class="flex-1 text-gray-500 font-bold">CANCELAR</button>
            <button onclick="salvarPedido()" class="flex-1 btn-gold">SALVAR ALTERAÇÕES</button>
        </div>
    </div>
</div>

<div id="printArea" class="hidden bg-white text-black p-10"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pedidoEditando = null;
const fM = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

function tab(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('btn-'+id).classList.add('active');
    if(id === 'pedidos') carregarPedidos();
    if(id === 'promocoes') carregarPainelPromos();
}

function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const area = document.getElementById('listaPedidos');
        area.innerHTML = '';
        s.forEach(ped => {
            const p = ped.val();
            area.innerHTML += `
            <div class="card flex justify-between items-center border-l-4 border-gold">
                <div>
                    <b class="text-gold uppercase">${p.cliente?.nome || 'Cliente'}</b>
                    <p class="text-[10px] text-gray-500">${p.data}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="abrirEditor('${ped.key}')" class="bg-white/10 px-4 py-2 rounded-lg text-[10px] font-bold">EDITAR</button>
                    <button onclick="imprimirRomaneio('${ped.key}')" class="bg-gold text-black px-4 py-2 rounded-lg text-[10px] font-bold">IMPRIMIR</button>
                </div>
            </div>`;
        });
    });
}

function abrirEditor(id) {
    pedidoEditando = id;
    db.ref('orders/'+id).once('value', s => {
        const p = s.val();
        document.getElementById('edClienteNome').value = p.cliente?.nome || '';
        document.getElementById('edClienteTel').value = p.cliente?.telefone || '';
        document.getElementById('edNomeEntrega').value = p.entrega?.nomeEntrega || '';
        document.getElementById('edRua').value = p.entrega?.rua || '';
        document.getElementById('edBairro').value = p.entrega?.bairro || '';
        document.getElementById('edCidade').value = p.entrega?.cidade || '';
        document.getElementById('edDesc').value = p.descontoPix || 0;
        document.getElementById('edFrete').value = p.frete || 0;
        
        const areaItens = document.getElementById('edItens');
        areaItens.innerHTML = '';
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        itens.forEach(item => {
            areaItens.innerHTML += `
            <div class="grid grid-cols-4 gap-2 bg-black/40 p-2 rounded item-linha">
                <input class="col-span-2 !mt-0" value="${item.name}">
                <input class="!mt-0" type="number" value="${item.price}" oninput="recalcularTotalEd()">
                <input class="!mt-0" type="number" value="${item.quantidade}" oninput="recalcularTotalEd()">
            </div>`;
        });
        recalcularTotalEd();
        document.getElementById('editorPedido').classList.remove('hidden');
    });
}

function recalcularTotalEd() {
    let sub = 0;
    document.querySelectorAll('.item-linha').forEach(l => {
        const ins = l.querySelectorAll('input');
        sub += (Number(ins[1].value) * Number(ins[2].value));
    });
    const total = sub - Number(document.getElementById('edDesc').value) + Number(document.getElementById('edFrete').value);
    document.getElementById('totalPreview').innerText = fM(total);
}

function salvarPedido() {
    const itens = [];
    document.querySelectorAll('.item-linha').forEach(l => {
        const ins = l.querySelectorAll('input');
        itens.push({ name: ins[0].value, price: Number(ins[1].value), quantidade: Number(ins[2].value) });
    });

    db.ref('orders/'+pedidoEditando).update({
        cliente: { nome: document.getElementById('edClienteNome').value, telefone: document.getElementById('edClienteTel').value },
        entrega: { 
            nomeEntrega: document.getElementById('edNomeEntrega').value,
            rua: document.getElementById('edRua').value,
            bairro: document.getElementById('edBairro').value,
            cidade: document.getElementById('edCidade').value
        },
        itens,
        descontoPix: Number(document.getElementById('edDesc').value),
        frete: Number(document.getElementById('edFrete').value),
        total: parseFloat(document.getElementById('totalPreview').innerText.replace(/[^\d,]/g, '').replace(',', '.'))
    }).then(() => { alert("Pedido Salvo!"); fecharEditor(); });
}

// --- LOGICA DE PROMOÇÕES POR CATEGORIA ---
async function carregarPainelPromos() {
    const [snapCats] = await Promise.all([db.ref('categories').once('value')]);
    const area = document.getElementById('listaPromos');
    area.innerHTML = '';
    
    snapCats.forEach(cat => {
        const c = cat.val();
        area.innerHTML += `
        <div class="bg-black/40 p-4 rounded-xl border border-white/5">
            <h4 class="text-gold font-bold text-[10px] uppercase mb-3">${c.name}</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <input id="p_pct_${cat.key}" type="number" value="${c.promoPct || 0}" placeholder="% Desc">
                <input id="p_tag_${cat.key}" type="text" value="${c.promoTag || 'OFERTA'}" placeholder="Texto Tag">
                <div class="flex flex-col items-center">
                    <label>Cor Fundo</label>
                    <input id="p_color_${cat.key}" type="color" value="${c.promoColor || '#d4af37'}" class="!h-10">
                </div>
                <div class="flex flex-col items-center">
                    <label>Cor Texto</label>
                    <input id="p_tcolor_${cat.key}" type="color" value="${c.promoTextColor || '#ffffff'}" class="!h-10">
                </div>
            </div>
        </div>`;
    });
}

function salvarPromocoes() {
    const updates = {};
    document.querySelectorAll('[id^="p_pct_"]').forEach(el => {
        const key = el.id.replace('p_pct_', '');
        updates[`categories/${key}/promoPct`] = Number(el.value);
        updates[`categories/${key}/promoTag`] = document.getElementById(`p_tag_${key}`).value;
        updates[`categories/${key}/promoColor`] = document.getElementById(`p_color_${key}`).value;
        updates[`categories/${key}/promoTextColor`] = document.getElementById(`p_tcolor_${key}`).value;
    });
    db.ref().update(updates).then(() => alert("Promoções Atualizadas!"));
}

function fecharEditor() { document.getElementById('editorPedido').classList.add('hidden'); }
window.onload = () => tab('pedidos');
</script>
</body>
</html>
