<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo • Luary Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #d4af37; --dark: #0b0b0b; --card: #141414; }
        body { background: var(--dark); color: #eee; font-family: 'Inter', sans-serif; margin: 0; }
        .serif { font-family: 'Playfair Display', serif; }
        .text-gold { color: var(--gold); }
        .bg-gold { background: var(--gold); }
        
        nav button { position: relative; transition: 0.3s; padding-bottom: 8px; opacity: 0.5; font-weight: bold; font-size: 10px; letter-spacing: 1px; }
        nav button.active { opacity: 1; color: var(--gold); }
        nav button.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--gold); }
        
        section { display: none; }
        section.active { display: block; animation: fadeIn 0.4s ease; }
        
        .card { background: var(--card); border: 1px solid #2a2a2a; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        input, select, textarea { background: #1a1a1a !important; border: 1px solid #333 !important; color: white !important; padding: 10px; border-radius: 8px; width: 100%; outline: none; font-size: 13px; margin-top: 5px; }
        input:focus { border-color: var(--gold) !important; }
        label { font-size: 10px; text-transform: uppercase; color: #666; font-weight: bold; }

        .btn-save { background: var(--gold); color: black; font-weight: bold; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.3s; text-transform: uppercase; font-size: 11px; }
        .btn-save:hover { opacity: 0.9; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; color: black !important; background: white !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<header class="p-6 border-b border-white/5 sticky top-0 bg-[#0b0b0b]/90 backdrop-blur-md z-50">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <h1 class="serif text-2xl text-gold">Luary <span class="text-white text-lg text-[12px]">Admin</span></h1>
        <nav class="flex gap-4 md:gap-8 overflow-x-auto pb-2 w-full md:w-auto">
            <button onclick="tab('pedidos')" class="active">PEDIDOS</button>
            <button onclick="tab('produtos')">PRODUTOS</button>
            <button onclick="tab('categorias')">CATEGORIAS</button>
            <button onclick="tab('promo')">PROMOÇÕES</button>
            <button onclick="tab('empresa')">EMPRESA</button>
        </nav>
    </div>
</header>

<main class="max-w-6xl mx-auto p-6 pb-20">

    <section id="pedidos" class="active">
        <div class="card">
            <div class="flex justify-between items-center mb-6 text-gold">
                <h2 class="serif text-xl">Gestão de Pedidos</h2>
                <span id="badgePedidos" class="bg-gold/10 text-[10px] px-3 py-1 rounded-full font-bold">0 TOTAL</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px]">
                    <thead class="text-gray-500 uppercase text-[9px] border-b border-white/5">
                        <tr>
                            <th class="py-4">Data/Cliente</th>
                            <th>Itens</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th class="text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaPedidos"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="produtos">
        <div class="flex justify-between items-center mb-6">
            <h2 class="serif text-xl">Catálogo</h2>
            <button onclick="abrirModalProduto()" class="bg-gold text-black px-4 py-2 rounded-lg text-[10px] font-bold uppercase">Novo +</button>
        </div>
        <div id="gridProdutos" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="categorias">
        <div class="card max-w-lg mx-auto">
            <h2 class="serif text-xl mb-6">Categorias</h2>
            <div id="listaCategorias" class="space-y-3"></div>
            <button onclick="addCategoria()" class="mt-4 text-gold text-[10px] font-bold uppercase underline w-full">Adicionar Categoria</button>
            <button onclick="salvarCategorias()" class="btn-save mt-4">Salvar Categorias</button>
        </div>
    </section>

    <section id="promo">
        <div class="card max-w-2xl mx-auto">
            <h2 class="serif text-xl mb-6">Configurar Promoções</h2>
            
            <div class="p-4 bg-gold/5 border border-gold/20 rounded-xl mb-8 flex justify-between items-center">
                <div>
                    <h3 class="text-xs font-bold text-gold">Banner do Topo</h3>
                    <p class="text-[9px] text-gray-400">Ativa a faixa promocional no cabeçalho do site.</p>
                </div>
                <button id="btnStatusPromo" onclick="toggleStatusPromo()" class="bg-gray-800 px-6 py-2 rounded-lg text-[10px] font-bold transition-all">CARREGANDO...</button>
            </div>

            <div id="configPromos" class="space-y-10">
                </div>

            <button onclick="salvarPromos()" class="btn-save mt-10">Aplicar Todas as Promoções</button>
        </div>
    </section>

    <section id="empresa">
        <div class="card max-w-2xl mx-auto">
            <h2 class="serif text-xl mb-6">Definições da Loja</h2>
            <form id="formEmpresa" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label>Nome da Loja</label><input name="nome"></div>
                <div><label>WhatsApp (Ex: 5519...)</label><input name="whats"></div>
                <div><label>Desconto PIX (%)</label><input name="descPix"></div>
                <div><label>Parcelas Sem Juros</label><input name="parcelas"></div>
                <div class="md:col-span-2"><label>URL Logo</label><input name="logo"></div>
                <button type="button" onclick="salvarEmpresa()" class="btn-save md:col-span-2">Salvar Empresa</button>
            </form>
        </div>
    </section>

</main>

<div id="modalProduto" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-[#141414] border border-white/10 w-full max-w-xl rounded-2xl p-6">
        <h2 class="serif text-gold mb-6">Detalhes do Produto</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2"><label>Nome</label><input id="p_name"></div>
            <div><label>Preço De</label><input type="number" id="p_old"></div>
            <div><label>Preço Por</label><input type="number" id="p_price"></div>
            <div><label>Categoria</label><select id="p_cat"></select></div>
            <div><label>Imagens (Links separados por vírgula)</label><input id="p_imgs"></div>
        </div>
        <div class="mt-6 flex gap-2">
            <button onclick="salvarProduto()" class="btn-save">Salvar</button>
            <button onclick="fecharModal()" class="btn text-white border-none">Sair</button>
        </div>
    </div>
</div>

<div id="modalRomaneio" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-white text-black w-full max-w-lg rounded-xl overflow-hidden shadow-2xl">
        <div id="printArea" class="p-8"></div>
        <div class="p-4 bg-gray-100 flex gap-2 no-print">
            <button onclick="window.print()" class="flex-1 bg-black text-white py-3 rounded-lg font-bold">IMPRIMIR</button>
            <button onclick="fecharModal()" class="flex-1 border py-3 rounded-lg font-bold">FECHAR</button>
        </div>
    </div>
</div>

<script>
// CONFIG FIREBASE LUARY
const firebaseConfig = {
    apiKey: "AIzaSyD62Yef2ggoAFSc-qKPlBTaRPRn20D91ug",
    databaseURL: "https://luary-shop-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentProductId = null;
const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

// --- GESTÃO DE ABAS ---
function tab(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    if(id === 'pedidos') listarPedidos();
    if(id === 'produtos') listarProdutos();
    if(id === 'categorias') carregarCategorias();
    if(id === 'promo') carregarPromos();
    if(id === 'empresa') carregarEmpresa();
}

// --- EMPRESA ---
function carregarEmpresa() {
    db.ref('settings/empresa').once('value', snap => {
        const d = snap.val() || {};
        const form = document.getElementById('formEmpresa');
        Object.keys(d).forEach(k => { if(form[k]) form[k].value = d[k]; });
    });
}
function salvarEmpresa() {
    const d = Object.fromEntries(new FormData(document.getElementById('formEmpresa')));
    db.ref('settings/empresa').update(d).then(() => alert("Loja Atualizada!"));
}

// --- CATEGORIAS ---
function carregarCategorias() {
    db.ref('categories').once('value', snap => {
        const cats = snap.val() || {};
        const box = document.getElementById('listaCategorias');
        box.innerHTML = '';
        Object.keys(cats).forEach(id => {
            box.innerHTML += `<div class="flex gap-2"><input class="cat-input" data-id="${id}" value="${cats[id].name}"> <button onclick="removerCat('${id}')" class="text-red-500 font-bold px-2">×</button></div>`;
        });
    });
}
function addCategoria() {
    const id = prompt("ID da categoria (sem espaços, ex: chaveiros_resina):");
    if(id) db.ref('categories/' + id).set({ name: id.toUpperCase() }).then(carregarCategorias);
}
function salvarCategorias() {
    const inputs = document.querySelectorAll('.cat-input');
    inputs.forEach(i => db.ref('categories/' + i.dataset.id).update({ name: i.value }));
    alert("Categorias Salvas!");
}

// --- PROMOÇÕES (LOGICA ABELLA INTEGRAL) ---
function carregarPromos() {
    db.ref('settings/promoStatus').on('value', snap => {
        const status = snap.val();
        const btn = document.getElementById('btnStatusPromo');
        btn.innerText = status ? 'ATIVA' : 'INATIVA';
        btn.className = `px-6 py-2 rounded-lg text-[10px] font-bold transition-all ${status ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
    });

    db.ref('categories').once('value', snap => {
        const cats = snap.val() || {};
        const box = document.getElementById('configPromos');
        box.innerHTML = '';

        Object.keys(cats).forEach(id => {
            const c = cats[id];
            box.innerHTML += `
            <div class="card p-6 border-gold/10 bg-gold/5">
                <h4 class="text-gold font-bold text-xs uppercase mb-4 tracking-widest border-b border-gold/10 pb-2">${c.name}</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div><label>Texto da Promo</label><input id="p_name_${id}" value="${c.promoName || ''}"></div>
                    <div><label>Texto da Tag</label><input id="p_tag_${id}" value="${c.promoTag || ''}"></div>
                    <div><label>% Desconto</label><input type="number" id="p_pct_${id}" value="${c.promoPct || 0}"></div>
                    <div><label>Cor do Fundo (Hex)</label><input id="p_color_${id}" value="${c.promoColor || '#caa85c'}"></div>
                    <div><label>Cor do Texto (Hex)</label><input id="p_tcolor_${id}" value="${c.promoTextColor || '#ffffff'}"></div>
                </div>
            </div>`;
        });
    });
}

function toggleStatusPromo() {
    const btn = document.getElementById('btnStatusPromo');
    const isAtiva = btn.innerText === 'ATIVA';
    db.ref('settings/promoStatus').set(!isAtiva);
}

function salvarPromos() {
    db.ref('categories').once('value', snap => {
        const cats = snap.val() || {};
        let updates = {};
        Object.keys(cats).forEach(id => {
            updates[`categories/${id}/promoName`] = document.getElementById(`p_name_${id}`).value;
            updates[`categories/${id}/promoTag`] = document.getElementById(`p_tag_${id}`).value;
            updates[`categories/${id}/promoPct`] = parseInt(document.getElementById(`p_pct_${id}`).value) || 0;
            updates[`categories/${id}/promoColor`] = document.getElementById(`p_color_${id}`).value;
            updates[`categories/${id}/promoTextColor`] = document.getElementById(`p_tcolor_${id}`).value;
        });
        db.ref().update(updates).then(() => alert("Promoções Aplicadas!"));
    });
}

// --- PRODUTOS ---
function listarProdutos() {
    db.ref('products').on('value', snap => {
        const prods = snap.val() || {};
        const grid = document.getElementById('gridProdutos');
        grid.innerHTML = '';
        Object.keys(prods).forEach(id => {
            const p = prods[id];
            grid.innerHTML += `
            <div class="card p-3 relative">
                <img src="${p.image?.split(',')[0]}" class="w-full h-32 object-cover rounded-lg">
                <h3 class="text-[10px] font-bold mt-3 uppercase truncate">${p.name}</h3>
                <p class="text-gold font-bold text-sm">${fM(p.price || 0)}</p>
                <div class="flex gap-1 mt-4">
                    <button onclick="editarProduto('${id}')" class="btn flex-1">EDITAR</button>
                    <button onclick="removerProduto('${id}')" class="text-red-500 px-2 font-bold">×</button>
                </div>
            </div>`;
        });
    });
}
function abrirModalProduto() { 
    currentProductId = null; 
    document.getElementById('modalProduto').classList.remove('hidden'); 
    db.ref('categories').once('value', snap => {
        const cats = snap.val() || {};
        document.getElementById('p_cat').innerHTML = Object.keys(cats).map(id => `<option value="${id}">${cats[id].name}</option>`).join('');
    });
}
function salvarProduto() {
    const p = {
        name: document.getElementById('p_name').value,
        priceOriginal: parseFloat(document.getElementById('p_old').value || 0),
        price: parseFloat(document.getElementById('p_price').value || 0),
        category: document.getElementById('p_cat').value,
        image: document.getElementById('p_imgs').value
    };
    if(currentProductId) db.ref('products/' + currentProductId).update(p);
    else db.ref('products').push(p);
    fecharModal();
}

// --- PEDIDOS (REPLICADO ABELLA) ---
function listarPedidos() {
    db.ref('orders').on('value', snap => {
        const peds = snap.val() || {};
        const tabela = document.getElementById('tabelaPedidos');
        const ids = Object.keys(peds).reverse();
        tabela.innerHTML = '';
        document.getElementById('badgePedidos').innerText = ids.length + " TOTAL";

        ids.forEach(id => {
            const p = peds[id];
            tabela.innerHTML += `
            <tr class="border-b border-white/5">
                <td class="py-4"><b>${p.cliente.nome}</b><br><span class="text-gray-500">${p.data}</span></td>
                <td>${p.itens?.length || 0} un.</td>
                <td class="text-gold font-bold">${fM(p.total || 0)}</td>
                <td>
                    <select onchange="atualizarStatus('${id}', this.value)" class="bg-transparent text-[10px] font-bold">
                        <option value="Novo" ${p.status==='Novo'?'selected':''}>NOVO</option>
                        <option value="Pago" ${p.status==='Pago'?'selected':''}>PAGO</option>
                        <option value="Enviado" ${p.status==='Enviado'?'selected':''}>ENVIADO</option>
                    </select>
                </td>
                <td class="text-right">
                    <button onclick="gerarRomaneio('${id}')" class="btn">ROMANEIO</button>
                    <button onclick="removerPedido('${id}')" class="text-red-500 font-bold ml-2">×</button>
                </td>
            </tr>`;
        });
    });
}

function gerarRomaneio(id) {
    db.ref('orders/' + id).once('value', snap => {
        const p = snap.val();
        const area = document.getElementById('printArea');
        area.innerHTML = `
            <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
                <h2 style="margin:0">LUARY SHOP</h2>
                <small>COMPROVANTE DE PEDIDO</small>
            </div>
            <p><b>CLIENTE:</b> ${p.cliente.nome}<br><b>ENDEREÇO:</b> ${p.endereco.rua}, ${p.endereco.bairro} - ${p.endereco.cidade}</p>
            <div style="margin-top:20px; font-size:12px;">
                ${p.itens.map(i => `<div style="display:flex; justify-content:space-between"><span>${i.quantidade}x ${i.name}</span><b>${fM(i.price*i.quantidade)}</b></div>`).join('')}
            </div>
            <h3 style="text-align:right; margin-top:20px;">TOTAL: ${fM(p.total)}</h3>
        `;
        document.getElementById('modalRomaneio').classList.remove('hidden');
    });
}

function fecharModal() { document.querySelectorAll('.fixed').forEach(m => m.classList.add('hidden')); }
function removerPedido(id) { if(confirm("Apagar pedido?")) db.ref('orders/' + id).remove(); }
function atualizarStatus(id, s) { db.ref('orders/'+id).update({status: s}); }

window.onload = () => tab('pedidos');
</script>
</body>
</html>
